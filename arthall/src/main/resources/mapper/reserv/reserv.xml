<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="reserv">

   <select id="count" parameterType="reserv.ReservVO" resultType="Integer"> 
      SELECT COUNT(*) FROM reserv
         <where>
         <!-- 날짜x, 검색어 o,x -->
            <if test="startDate == null or startDate == '' or endDate == null or endDate == ''">
               <!-- 특정 항목에서 검색  -->
               <if test="stype != 'all' and sval != null and sval !=''" >
                   ${stype} like '%${sval}%'
               </if>
               <!-- 전체 항목에서 검색 -->
               <if test="stype == 'all' and sval != null and sval !=''" >
                   name like '%${sval}%' OR playName like '%${sval}%' OR hallNo like '%${sval}%'
               </if>
            </if>
            
            <!-- 날짜o, 검색어 o,x -->
            <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
               <!-- 검색어 없을때 -->
               <if test="stype == 'all' and (sval == null or sval =='') " >
                   reservDate BETWEEN #{startDate} AND #{endDate}
                   
               </if>
               <!-- stype:all, sval:o -->
               <!-- stype all인 경우는 검색어가 확실히? 있음  -->
               <if test="stype == 'all' and (sval != null and sval !='') ">
                  (name like '%${sval}%' OR playName like '%${sval}%' OR hallNo LIKE '%${sval}%') AND
                  reservDate in 
                  (SELECT distinct reservDate 
                  FROM reserv WHERE reservDate 
                  BETWEEN #{startDate} AND #{endDate})
               </if>
               
               <!-- stype!=all, sval: o -->
               <!-- stype all이 아닌 경우는 검색어가 확실히? 있음-->
               <if test="stype != 'all' and sval != null and sval !=''">
                  (${stype} like '%${sval}%') AND
                  reservDate in 
                  (SELECT distinct reservDate 
                  FROM reserv WHERE reservDate 
                  BETWEEN #{startDate} AND #{endDate})
               </if>
            </if>
         </where>
   </select>

	<!-- reservlist -->
	<select id="list" parameterType="reserv.ReservVO" resultType="reserv.ReservVO">
	   SELECT * FROM reserv
	   <where>
	   <!-- 날짜x, 검색어 o,x -->
	   		<if test="startDate == null or startDate == '' or endDate == null or endDate == ''">
	            <!-- 특정 항목에서 검색  -->
	            <if test="stype != 'all' and sval != null and sval !=''" >
	                ${stype} like '%${sval}%'
	            </if>
	            <!-- 전체 항목에서 검색  -->
	            <if test="stype == 'all' and sval != null and sval !=''" >
	                name like '%${sval}%' OR playName like '%${sval}%' OR hallNo like '%${sval}%'
	            </if>
	         </if>
	         
	         <!-- 날짜o, 검색어 o,x -->
	         <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
	            <!-- 검색어 없을 때 -->
	            <if test="stype == 'all' and (sval == null or sval =='') " >
	                reservDate BETWEEN #{startDate} AND #{endDate}
	            </if>
	            
	            <!-- stype:all, sval:o -->
	            <!-- stype all인 경우는 검색어가  확실히? 있음 -->
	            <if test="stype == 'all' and (sval != null and sval !='') ">
	               (name like '%${sval}%' OR playName like '%${sval}%' OR hallNo LIKE '%${sval}%') AND
	               reservDate in 
	               (SELECT distinct reservDate 
	               FROM reserv WHERE reservDate 
	               BETWEEN #{startDate} AND #{endDate})
	            </if>
	            
	            <!-- stype!=all, sval: o -->
	            <!-- stype all이 아닌 경우는 검색어가  확실히? 있음 -->
	            <if test="stype != 'all' and sval != null and sval !=''">
	               (${stype} like '%${sval}%') AND
	               reservDate in 
	               (SELECT distinct reservDate 
	               FROM reserv WHERE reservDate 
	               BETWEEN #{startDate} AND #{endDate})
	            </if>
	         </if>
	   </where>
	   ORDER BY reservDate desc
	   LIMIT #{startRow},#{size}
	</select>
	
	
	   <!-- ticketlist -->
	<select id="ticketlist" parameterType="reserv.TicketVO" resultType="reserv.TicketVO">
	   SELECT * FROM ticket
	   WHERE reservNo = #{reservNo}
	</select>
   
   
   <!-- 예매취소 reserv-->
   <update id="cancleReserv" parameterType="reserv.ReservVO">
      UPDATE reserv SET
         pay="예매취소"
      WHERE reservNo=#{reservNo}
   </update>
   
   
   <!-- 예매취소 ticket -->
   <update id="cancleTicket" parameterType="reserv.ReservVO">
      UPDATE ticket SET 
         pay="예매취소" 
      WHERE reservNo=#{reservNo}
   </update>
   
   
	<!-- 뭐ㅣ? -->  
   <select id="playOne" parameterType="reserv.ReservVO" resultType="play.PlayVO">
      select * from play WHERE playName = #{playName}
   </select>
   
   
   <!-- 여기 reservVO에 playName이 있고 이걸로 perform에서 조회하는거 -->
   <select id="playList" parameterType="reserv.ReservVO" resultType="play.PerformVO">
      select * from perform WHERE playName = #{playName}
   </select>
   
   <select id="playPrice" parameterType="reserv.ReservVO" resultType="play.PerformVO">
      select * from perform WHERE playName = #{playName} AND time = #{time}
   </select>
   
   
   <insert id="reservOne" parameterType="reserv.ReservVO">
      INSERT INTO reserv
         (reservNo, memberNo, name, reservDate, playNo, playName, playDate, time, hallNo, hallName, pay,
         price, seat)
      VALUES
         (#{reservNo}, #{memberNo}, #{name}, now(), #{playNo}, #{playName}, #{playDate},
            #{time}, #{hallNo}, #{hallName}, #{pay}, #{price}, #{seat});
      <selectKey keyProperty="no" resultType="Integer" order="AFTER">
         SELECT last_insert_id();
      </selectKey>
   </insert>
   
   <insert id="reservTicket" parameterType="reserv.TicketVO">
      INSERT INTO ticket
         (reservNo, seatType, price, pay)
      VALUES
         (#{reservNo}, #{seatType}, #{price}, #{pay});
      <selectKey keyProperty="no" resultType="Integer" order="AFTER">
         SELECT last_insert_id();
      </selectKey>
   </insert>
   
   
   <!--  -->
   <select id="hall" parameterType="reserv.ReservVO" resultType="reserv.HallVO">
      SELECT * FROM hall WHERE hallName = #{hallName}
   </select>
   
   
   <!--  -->
   <select id="reservNumber" resultType="reserv.ReservVO">
      SELECT * FROM reserv ORDER BY NO DESC LIMIT 1
   </select>
   
   <!-- 지난 공연 정보 -->
   <select id="reservSessPass" parameterType="member.MemberVO" resultType="reserv.ReservVO">
   	  SELECT * FROM reserv WHERE memberNo = #{no} and now() > playDate ORDER BY playDate desc
   </select>
   
   <!-- 남은 공연 정보 -->
   <select id="reservSess" parameterType="member.MemberVO" resultType="reserv.ReservVO">
   	  SELECT * FROM reserv WHERE memberNo = #{no} and playDate > now() ORDER BY playDate desc
   </select>
</mapper>